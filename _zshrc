# rbenv
function complete() {} # workaround
export CONFIGURE_OPTS="--with-opt-dir=/usr/local"
export PATH=/Users/hibariya/local/bin:$HOME/.rbenv/bin:$PATH
eval "$(rbenv init -)"
source ~/.rbenv/completions/rbenv.zsh

autoload -U compinit
compinit

# show branch
autoload -Uz vcs_info
autoload -Uz is-at-least

zstyle ':vcs_info:*' formats '[%s: %b]'
zstyle ':vcs_info:*' actionformats '[%s: %b (%a)]'

if is-at-least 4.3.10; then
  zstyle ':vcs_info:git:*' check-for-changes true
  zstyle ':vcs_info:git:*' stagedstr " (staged)"
  zstyle ':vcs_info:git:*' unstagedstr " (unstaged)"
  zstyle ':vcs_info:git:*' formats '[%s: %b%c%u]'
  zstyle ':vcs_info:git:*' actionformats '[%s: %b%c%u (%a)]'
fi

precmd () {
  psvar=()
  vcs_info
  [[ -n "$vcs_info_msg_0_" ]] && psvar[1]="$vcs_info_msg_0_"
  set_rprompt
}

zstyle ':completion:*' verbose yes
zstyle ':completion:*:descriptions' format '%B%d%b'
zstyle ':completion:*:messages' format '%d'
zstyle ':completion:*:warnings' format 'No matches for: %d'
zstyle ':completion:*' group-name ''
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

zstyle ':completion:*:default' list-colors ${LS_COLORS}
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([%0-9]#)*=0=01;31'

HISTFILE=~/.zsh_history
HISTSIZE=100000
SAVEHIST=100000
setopt hist_ignore_all_dups
setopt hist_ignore_dups
setopt share_history
setopt append_history
setopt inc_append_history
setopt hist_no_store
setopt hist_reduce_blanks
setopt auto_cd
setopt auto_menu
setopt list_packed
setopt list_types
setopt magic_equal_subst
setopt print_eight_bit
setopt auto_pushd
setopt CORRECT_ALL

bindkey -e
bindkey "^R" history-incremental-search-backward
bindkey "^S" history-incremental-search-forward
#bindkey "^p" up-line-or-history
bindkey '^P' history-beginning-search-backward
bindkey '^N' history-beginning-search-forward
bindkey -a 'q' push-line

SPROMPT="%r is correct? [n,y,a,e]: "
PROMPT="%n@ ;-) "

alias emoji='open http://www.emoji-cheat-sheet.com/'
alias h='history -E -32'
alias ll='ls -laFG'
alias l='ll'
alias tailf="tail -f"
alias -g L=" | less "
alias -g V=" | vim -R - "
alias info='info --vi-keys'
alias bo='bundle open'
alias be='bundle exec'
alias bu='bundle update'
alias co='cline open'
alias g='git'
alias reload='source ~/.zshrc'
alias tmux='tmux -2'
source ~/.zshenv
source ~/.zsh/*

function v() { vim `echo $* | gsed -e "s/:\([0-9]\+\)/ +\1/"` }
function preexec(){ echo -ne "\ek${(z)2}\e\\" }
function set_rprompt(){
  # XXX 重い...
  RPROMPT="%F{cyan}[%~] %1(v|%F{cyan}%1v%f|) %F{red}[ruby: `rbenv version | sed -e 's/ .*//'`]%f"
}

# tmux
if ! [[ $TMUX_LEAF_LOADED = true ]]; then
  if ! [[ $TMUX_STEM_LOADED = true ]]; then
    TMUX_STEM_LOADED=true TMUX= tmux -L stem -f ~/.tmux/stem.conf
  else
    if [[ $TMUX_PANE = "%0" ]]; then
      tmux split-window
      tmux resize-pane -D 100
      tmux resize-pane -U 2
      tmux select-pane -U
      TMUX_LEAF_LOADED=true TMUX= tmux -L leaf -f ~/.tmux/leaf.conf
    fi

    if [[ $TMUX_PANE = "%1" ]]; then
      cline tick 1 5
    fi
  fi
fi

set_rprompt
